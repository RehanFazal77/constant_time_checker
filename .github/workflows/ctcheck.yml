name: CT Checker CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ct-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential cmake git libssl-dev

    - name: Build liboqs from source
      run: |
        git clone --depth 1 https://github.com/open-quantum-safe/liboqs.git
        cd liboqs
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release ..
        make -j$(nproc)
        sudo make install
        cd ../..

    - name: Compile ct-checker
      run: |
        gcc -O2 -Wall -I/usr/local/include -o ct-checker harness.c -L/usr/local/lib -loqs -lcrypto -lm

    - name: Run ct-checker with CI-style status
      run: |
        echo "Running ct-checker..."
        ./ct-checker
      continue-on-error: true

    - name: Determine CI status
      id: status
      run: |
        output=$(./ct-checker)
        echo "$output"
        if echo "$output" | grep -q "‚ùå"; then
          echo "Timing difference detected, marking job as failed"
          exit 1
        else
          echo "No significant timing difference detected"
          exit 0
        fi
